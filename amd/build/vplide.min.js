define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplidefile","mod_vpl/vplidebutton","mod_vpl/vplterminal","mod_vpl/vplvnc"],function(a,b,c,d,e,f,g){if("undefined"!=typeof i)return i;var h,i=function(b,j){function k(a){return!T[a]||j[a]}function l(a){M?a.originalEvent.dataTransfer.dropEffect="none":a.originalEvent.dataTransfer.dropEffect="copy",a.preventDefault()}function m(a){if(M)return a.stopImmediatePropagation(),!1;var b=a.originalEvent.dataTransfer;return b.files.length>0?(c.readSelectedFiles(b.files,function(a){return E.addFile(a,!0,I,H)},function(){E.fileListVisibleIfNeeded()}),a.stopImmediatePropagation(),!1):void 0}function n(a){if(M)return a.stopPropagation(),!1}function o(a,b){if("newHeader"in b&&b.newHeader.hasClass("vpl_ide_accordion_t_grade"))return!1}function p(){function b(a){for(var b=a.toLowerCase()+"/",c=0;c<i.length;c++){var d=i[c].getFileName().toLowerCase()+"/";if(0===d.indexOf(b)||0===b.indexOf(d))return!0}return!1}function e(a,b){if(c.isBlockly(a))return!1;if(c.isBlockly(b))for(var d=0;d<i.length;d++)if(c.isBlockly(i[d].getFileName()))return!0;return!1}var f=a("#vpl_tabs_ul"),g=a("#vpl_tabs").tabs("widget"),i=[],k=[],o=!0,p=this;this.updateFileList=function(){p.generateFileList()},this.fileNameExists=function(a){for(var b=a.toLowerCase(),c=0;c<i.length;c++)if(i[c].getFileName().toLowerCase()==b)return c;return-1},this.restrictedPaste=n,this.dropHandler=m,this.dragoverHandler=l,this.readOnly=N,this.restrictedEdit=M,this.adjustTabsTitles=F,this.minNumberOfFiles=K,this.scrollBarWidth=P;var q="";this.setClipboard=function(a){q=a},this.getClipboard=function(){return q},this.getTabPos=function(a){for(var b=0;b<k.length;b++)if(k[b]==a)return b;return k.length},this.getTheme=function(){return j.theme},this.setTheme=function(a){j.theme=a;for(var b=0;b<i.length;b++)i[b].setTheme(a)},this.addTab=function(a){var b='<a href="#vpl_file'+a+'"></a>';f.append('<li id="vpl_tab_name'+a+'">'+b+"</li>"),g.append('<div id="vpl_file'+a+'" class="vpl_ide_file"></div>')},this.removeTab=function(a){f.find("#vpl_tab_name"+a).remove(),g.find("#vpl_file"+a).remove()},this.open=function(a){var b;if(b="object"==typeof a?a:i[a],!b.isOpen()){var d=b.getId();p.addTab(d),k.push(b),V.setGetkeys(b.open()),g.tabs("refresh"),F(!1),c.delay("updateMenu",I),c.delay("updateFileList",p.updateFileList)}},this.close=function(a){if(a.isOpen()){var b,d=a.getId();a.close(),p.removeTab(d);var e=p.getTabPos(a);return k.splice(e,1),g.tabs("refresh"),F(!1),p.fileListVisible(!0),c.delay("updateFileList",p.updateFileList),c.delay("adjustTabsTitles",F,!1),k.length>e?(b=p.getFilePosById(k[e].getId()),void p.gotoFile(b,"c")):e>0?(b=p.getFilePosById(k[e-1].getId()),void p.gotoFile(b,"c")):void 0}},this.isClosed=function(a){return!i[a].isOpen()},this.fileListVisible=function(a){a!==X.vpl_visible&&(X.vpl_visible=a,a?(X.show(),G()):(X.hide(),G()))},this.isFileListVisible=function(){return X.vpl_visible},this.fileListVisibleIfNeeded=function(){if(!this.isFileListVisible())for(var a=0;a<i.length;a++)if(!i[a].isOpen())return void this.fileListVisible(!0)},this.setFontSize=function(a){j.fontSize=a;for(var b=0;b<i.length;b++)i[b].setFontSize(a)},this.getFontSize=function(){return j.fontSize},this.addFile=function(a,f,g,k){if("string"!=typeof a.name||!c.validPath(a.name))return k(R("incorrect_file_name")+" ("+a.name+")"),!1;f!==!0&&(f=!1);var l=this.fileNameExists(a.name);if(l!=-1)return f?(i[l].setContent(a.contents),p.setModified(),g(),c.delay("updateFileList",p.updateFileList),a):(k(R("filenotadded").replace(/\{\$a\}/g,a.name)),!1);if(b(a.name)||e("",a.name))return k(R("filenotadded").replace(/\{\$a\}/g,a.name)),!1;if(i.length>=L)return k(R("maxfilesexceeded")+" ("+L+")"),!1;var m=c.getUniqueId(),n=new d(m,a.name,a.contents,this,h,j.id);return 1==a.encoding?n.extendToBinary():c.isBlockly(a.name)?n.extendToBlockly():n.extendToCodeEditor(),i.push(n),p.setModified(),i.length>5&&p.fileListVisible(!0),g(),c.delay("updateFileList",p.updateFileList),n},this.renameFile=function(a,d,f){var g=this.fileNameExists(a);try{if(g==-1)throw"";if(g<K)throw"";if(i[g].getFileName()==d)return!0;if(!c.validPath(d)||b(d)||e(a,d))throw R("incorrect_file_name");if(c.isBinary()&&c.fileExtension(a)!=c.fileExtension(d))throw R("incorrect_file_name");if(!c.isBlockly(a)&&c.isBlockly(d)||c.isBlockly(a)&&!c.isBlockly(d))throw R("incorrect_file_name");i[g].setFileName(d)}catch(h){return f(R("filenotrenamed").replace(/\{\$a\}/g,d)+": "+h),!1}return p.setModified(),F(!1),c.delay("updateFileList",p.updateFileList),!0},this.deleteFile=function(a,b,d){var e=this.fileNameExists(a);return e==-1?(d(R("filenotdeleted").replace(/\{\$a\}/g,a)),!1):e<K?(d(R("filenotdeleted").replace(/\{\$a\}/g,a)),!1):(p.setModified(),p.close(i[e]),i.splice(e,1),c.delay("updateFileList",p.updateFileList),!0)},this.currentFile=function(){var a=g.tabs("option","active");if(a in k){var b=k[a];if(0===arguments.length)return b;var c=arguments[0];if("function"==typeof b[c]){var d=b[c],e=Array.prototype.slice(arguments);return e.shift(),d.apply(b,e)}}return!1},this.currentPos=function(){return g.tabs("option","active")},this.getFileTab=function(a){for(var b=0;b<k.length;b++)if(k[b].getId()==a)return b;return-1},this.getFilePosById=function(a){for(var b=0;b<i.length;b++)if(i[b].getId()==a)return b;return-1},this.gotoFile=function(a,b){var c=i[a];p.open(c),g.tabs("option","active",p.getFileTab(c.getId())),"c"!==b&&c.gotoLine(parseInt(b,10)),c.focus()},this.gotoFileLink=function(b){var c=a(b),d=c.data("file"),e=-1;if(e=d>""?this.fileNameExists(d):p.getFilePosById(c.data("fileid")),e>=0){var f=c.data("line");"undefined"==typeof f&&(f="c"),p.gotoFile(e,f)}},this.getFilesToSave=function(){for(var a=[],b=0;b<i.length;b++){var c={};c.name=i[b].getFileName(),c.contents=i[b].getContent(),c.encoding=i[b].isBinary()?1:0,a.push(c)}return a},this.resetModified=function(){o=!1;for(var a=0;a<i.length;a++)i[a].resetModified();c.delay("updateMenu",I),c.delay("updateFileList",p.updateFileList)},this.setModified=function(){o||(o=!0,c.delay("updateFileList",p.updateFileList)),c.delay("updateMenu",I)},this.isModified=function(){return o},this.length=function(){return i.length},this.clearAnnotations=function(){for(var a=0;a<i.length;a++)i[a].clearAnnotations()},this.getFile=function(a){return i[a]},this.getFiles=function(){return i},this.getDirectoryStructure=function(){var a={isDir:!0,content:{}};for(var b in i)if(i.hasOwnProperty(b)){var c=i[b],d=c.getFileName(),e=d.split("/"),f=a;for(var g in e)if(e.hasOwnProperty(g)){var h=e[g];g==e.length-1?f.content[h]={isDir:!1,content:c,pos:b}:(f.content[h]||(f.content[h]={isDir:!0,content:{}}),f=f.content[h])}}return a},this.generateFileList=function(){function a(d,e,f){for(var g in d.content)if(d.content.hasOwnProperty(g)){var h=d.content[g];if(h.isDir)f.push(e+c.iconFolder()+c.sanitizeText(g)),a(h,e+b,f);else{var i=h.content,j=c.sanitizeText(g),k=c.sanitizeText(i.getFileName());i.isOpen()&&(j="<b>"+j+"</b>");var l='href="#" data-fileid="'+i.getId()+'" title="'+k+'"',m="<a "+l+">"+j+"</a>";i.isModified()&&(m=c.iconModified()+m),h.pos<K&&(m+=c.iconRequired()),f.push(e+m)}}}if(p.isFileListVisible()){var b='<span class="vpl_ide_dirindent"></span>',d=p.getDirectoryStructure(),e=[],f="";a(d,"",e);for(var g=0;g<e.length;g++)f+=e[g]+"<br />";Z.html("<div>"+f+"</div>")}},f.on("click","span.vpl_ide_closeicon",function(){E.close(E.currentFile())}),f.on("dblclick","span.vpl_ide_closeicon",V.getAction("delete")),f.on("dblclick","a",V.getAction("rename")),Z.on("dblclick","a",V.getAction("rename"))}function q(){return ca===!1&&(ca=(_.outerWidth(!0)-_.width())/2),ca}function r(a,b){var c,d=b.position.left-b.originalPosition.left;if(0!==d)c=_.width()+X.width()-X.vpl_minWidth,_.resizable("option","maxWidth",c),X.width(X.vpl_original_width+d);else{c=_.width()+aa.width()-aa.vpl_minWidth,_.resizable("option","maxWidth",c);var e=b.size.width-b.originalSize.width;aa.width(aa.vpl_original_width-e)}E.currentFile("adjustSize")}function s(){var a=["e","w","e","e, w"],b=0;b+=X.vpl_visible?1:0,b+=aa.vpl_visible?2:0,_.resizable("destroy"),da.handles=a[b],da.disable=0===b,_.resizable(da)}function t(){var b=a(window).outerHeight();b-=U.offset().top+U.height()+(O?q():20),b<150&&(b=150),W.height(b);var c=b-3*q();_.height(c),aa.vpl_visible&&(aa.height(c+q()),ba.accordion("refresh")),X.vpl_visible&&(Z.height(c-(Y.outerHeight()+q())),X.height(c))}function u(){E.currentFile("focus")}function v(b,d){return c.showMessage(b,a.extend({},ea,d))}function w(b){if("click"==b.type||"keypress"==b.type&&13==b.keyCode){fa.dialog("close");var c={name:a("#vpl_ide_input_newfilename").val(),contents:"",encoding:0},d=E.addFile(c,!1,I,H);return d&&(E.open(d),_.tabs("option","active",E.getTabPos(d)),d.focus()),!1}}function x(b){("click"==b.type||"keypress"==b.type&&13==b.keyCode)&&(ha.dialog("close"),E.renameFile(E.currentFile("getFileName"),a("#vpl_ide_input_renamefilename").val(),H),b.preventDefault())}function y(){c.requestAction("resetfiles","",{},j.ajaxurl).done(function(a){var b=a.files;for(var d in b)b.hasOwnProperty(d)&&E.addFile(b[d],!0,c.doNothing,H);E.fileListVisibleIfNeeded(),c.delay("updateMenu",I)}).fail(H)}function z(){c.requestAction("correctedfiles","",{},j.ajaxurl).done(function(a){var b=a.files;for(var d in b)E.addFile(b[d],!0,c.doNothing,H);E.fileListVisibleIfNeeded()}).fail(H)}function A(a,b,d){d||(d={}),ya.isConnected()||c.requestAction(a,"",d,j.ajaxurl).done(function(d){c.webSocketMonitor(d,a,b,Ba)}).fail(H)}function B(){A("run","running",{XGEOMETRY:xa.getCanvasSize()})}function C(){A("debug","debugging",{XGEOMETRY:xa.getCanvasSize()})}function D(){A("evaluate","evaluating")}var E,F,G,H,I,J=this,K=j.minfiles||0,L=j.maxfiles||0,M=j.restrictededitor||j.example,N=j.example,O=!1,P=c.scrollBarWidth();c.setStr(j.i18n);var Q,R=c.str,S=a("#"+b);if(Q="undefined"==typeof c.get_absolute_path()?"../editor/VPLIDE.css":c.get_absolute_path()+"/editor/VPLIDE.css",a("head").append('<meta name="viewport" content="initial-scale=1">').append('<meta name="viewport" width="device-width">').append('<link rel="stylesheet" href="'+Q+'"/>'),"object"!=typeof S)throw"VPL: constructor tag_id not found";var T={"new":!0,rename:!0,"delete":!0,save:!0,run:!0,edit:!0,debug:!0,evaluate:!0,"import":!0,resetfiles:!0,correctedfiles:!0,sort:!0,multidelete:!0,acetheme:!0,console:!0,comments:!0};"undefined"==typeof j.loadajaxurl&&(j.loadajaxurl=j.ajaxurl),function(){var a=K<L;j["new"]=a,j.rename=a,j["delete"]=a,j.comments=j.comments&&!j.example,j.acetheme=!0}(),j.sort=L-K>=2,j.multidelete=j.sort,j["import"]=!M,j.console=k("run")||k("debug"),"undefined"==typeof j.fontSize&&(j.fontSize=12),j.fontSize=parseInt(j.fontSize),S.on("drop",m),S.on("dragover",l);var U=a("#vpl_menu"),V=new e(U,k),W=a("#vpl_tr"),X=a("#vpl_filelist"),Y=a("#vpl_filelist_header"),Z=a("#vpl_filelist_content"),$=a("#vpl_tabs_ul"),_=a("#vpl_tabs"),aa=a("#vpl_results"),ba=a("#vpl_results_accordion");X.vpl_minWidth=80,aa.vpl_minWidth=100,this.updateEvaluationNumber=function(a){if("undefined"!=typeof a.nevaluations){var b=a.nevaluations;"undefined"!=typeof a.reductionbyevaluation&&a.reductionbyevaluation>""&&0!=a.reductionbyevaluation&&(0!=a.freeevaluations&&(b=b+"/"+a.freeevaluations),b=b+" -"+a.reductionbyevaluation),V.setExtracontent("evaluate",b)}},this.lastResult=null,this.getTerminal=function(){return wa},this.setResultGrade=function(a,b){var c="grade",d="vpl_ide_accordion_t_"+c,e="vpl_ide_accordion_c_"+c;if(0==ba.find("."+e).length&&(ba.append('<div class="'+d+'"></div>'),ba.append('<div class="'+e+'"></div>')),"undefined"==typeof b)return ba.find("h4."+d).length>0;var f=ba.find("."+d);return a>""?(f.replaceWith('<h4 class="'+d+'">'+a+"</h4>"),!0):(f.replaceWith('<div class="'+d+'"></div>'),!1)},this.setResultTab=function(b,c,d){var e="vpl_ide_accordion_t_"+b,f="vpl_ide_accordion_c_"+b;if(0==ba.find("."+f).length&&(ba.append('<div class="'+e+'"></div>'),ba.append('<div class="'+f+'"></div>')),"undefined"==typeof d)return ba.find("h4."+e).length>0;var g=ba.find("."+e),h=ba.find("."+f),i=a("<div>"+c+"</div>");return i.find("h4").replaceWith(function(){return a("<h5>").append(a(this).contents())}),h.html()==i.html()?c>"":c>""?(g.replaceWith('<h4 class="'+e+'">'+R(b)+"</h4>"),h.replaceWith('<div class="ui-widget '+f+'">'+i.html()+"</div>"),!0):(g.replaceWith('<div class="'+e+'"></div>'),h.replaceWith('<div class="'+f+'"></div>'),!1)},this.setResult=function(a,b){J.updateEvaluationNumber(a);var d,e=E.getFiles(),f=[];for(d=0;d<e.length;d++)f[d]=e[d].getFileName(),e[d].clearAnnotations();var g,h,i,k=!1,l=c.sanitizeText(a.grade);if(h=J.setResultGrade(l,a.grade),k=k||h,g=J.setResultTab("variables",a.variables,a.variables),k=k||g,i=c.processResult(a.compilation,f,e,!0,!1),g=J.setResultTab("compilation",i,a.compilation),k=k||g,i=c.processResult(a.evaluation,f,e,!1,!1),g=J.setResultTab("comments",i,a.evaluation),k=k||g,i=c.sanitizeText(a.execution),g=J.setResultTab("execution",i,a.execution),k=k||g,g=J.setResultTab("description",j.description,j.description),k=k||g){for(aa.show(),aa.vpl_visible=!0,ba.accordion("refresh"),ba.accordion("option","active",h?1:0),d=0;d<e.length;d++)for(var m=e[d].getAnnotations(),n=0;n<m.length;n++)if(b||"error"==m[n].type){E.gotoFile(d,m[n].row+1);break}}else aa.hide(),aa.vpl_visible=!1;c.delay("autoResizeTab",G)},ba.accordion({heightStyle:"fill",header:"h4",animate:!1,beforeActivate:o}),aa.width(2*aa.vpl_minWidth),ba.on("click","a",function(a){a.preventDefault(),E.gotoFileLink(a.currentTarget)}),aa.vpl_visible=!1,aa.hide(),X.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),Y.text(R("filelist")),Y.html(c.iconFolder()+Y.html()),Y.addClass("ui-widget-header ui-button-text-only ui-corner-all"),Z.addClass("ui-widget ui-corner-all"),X.width(2*X.vpl_minWidth),X.on("click","a",function(a){a.preventDefault(),E.gotoFileLink(a.currentTarget)}),X.vpl_visible=!1,X.hide(),_.tabs({classes:{"ui-tabs-panel":null}});var ca=!1,da={containment:"parent",resize:r,start:function(){a(window).off("resize",G),_.resizable("option","minWidth",100),aa.vpl_visible&&(aa.vpl_original_width=aa.width()),X.vpl_visible&&(X.vpl_original_width=X.width())},stop:function(b,c){r(b,c),_.resizable("option","maxWidth",1e5),_.resizable("option","minWidth",0),G(),a(window).on("resize",G)},handles:""};_.resizable(da),F=function(b){var c=_.width(),d=0;$.width(1e5);var e=$.children("li:visible").last();if(e.length){var f=$.parent().scrollLeft();d=f+e.position().left+e.width()+ca,$.width(d);var g=E.currentFile();if(g&&b){var h=a(g.getTabNameId()),i=f+h.position().left;i-=(c-h.outerWidth())/2,i<0&&(i=0),$.parent().finish().animate({scrollLeft:i},"slow")}}d<c&&$.width("")},G=function(){var a=_.width(),b=U.width(),c=!1;if(s(),W.width(U.outerWidth()),X.vpl_visible){var d=X.outerWidth()+ca;a+=d,d>=100?(b-=d,_.css("left",d)):c=!0}else _.css("left",0);if(aa.vpl_visible){var e=aa.outerWidth()+ca;a+=e,b-=e,b<100&&(c=!0)}if(c){var f=U.width()/a,g=0;X.vpl_visible&&(g=X.width()*f,X.width(g-ca),g+=ca,_.css("left",g)),_.width(_.width()*f),aa.vpl_visible&&aa.width(U.width()-(g+_.width()+ca))}else _.width(b);F(!0),t(),E.currentFile("adjustSize")};var ea=a.extend({},{close:u},c.dialogbaseOptions);H=function(a){return c.showErrorMessage(a,{close:u})};var fa=a("#vpl_ide_dialog_new"),ga={};ga[R("ok")]=w,ga[R("cancel")]=function(){a(this).dialog("close")},fa.find("input").on("keypress",w),fa.dialog(a.extend({},ea,{title:R("create_new_file"),buttons:ga}));var ha=a("#vpl_ide_dialog_rename");ha.find("input").on("keypress",x),ga[R("ok")]=x,ha.dialog(a.extend({},ea,{open:function(){a("#vpl_ide_input_renamefilename").val(E.currentFile("getFileName"))},title:R("rename_file"),buttons:ga})),ga[R("ok")]=function(){a(this).dialog("close")};var ia=a("#vpl_ide_dialog_comments");ia.dialog(a.extend({},ea,{title:R("comments"),width:"40em",buttons:ga})),a("#vpl_ide_input_comments").width("30em");var ja=a("#vpl_ide_dialog_about"),ka={};ka[R("ok")]=function(){a(this).dialog("close")};var la=a("#vpl_ide_dialog_shortcuts");la.dialog(a.extend({},ea,{open:function(){var b=V.getShortcuts(E.currentFile("getEditor"));a("#vpl_ide_dialog_shortcuts").html(b)},title:R("shortcuts"),width:400,height:300,buttons:ka})),la.dialog("option","height",300),ka[R("shortcuts")]=function(){a(this).dialog("close"),la.dialog("open")},ja.dialog(a.extend({},ea,{open:function(){var b=V.getShortcuts(E.currentFile("getEditor"));ja.next().find("button").filter(function(){return a(this).text()==R("shortcuts")}).button(""!=b?"enable":"disable")},title:R("about"),width:400,height:300,buttons:ka})),ja.dialog("option","height",300);var ma=a("#vpl_ide_dialog_sort"),na={};na[R("ok")]=function(){var b=E.getFiles(),d=/[^\d]*/,e=[],f=0,g=a("#vpl_sort_list li");if(g.length==b.length){for(g.each(function(){var a=parseInt(this.id.replace(d,""));e.push(b[a])}),f=0;f<g.length;f++)b[f]=e[f];E.setModified(),c.delay("updateMenu",I),c.delay("updateFileList",E.updateFileList),a(this).dialog("close")}},na[R("cancel")]=function(){a(this).dialog("close")},ma.dialog(a.extend({},ea,{title:R("sort"),buttons:na,open:function(){var b=a("#vpl_sort_list");b.html("");for(var c=E.getFiles(),d=0;d<c.length;d++){var e=a('<li id="vpl_fsort_'+d+'"class="ui-widget-content"></li>');d<K&&e.addClass("ui-state-disabled"),e.text(d+1+"-"+c[d].getFileName()),b.append(e)}b.sortable({items:"li:not(.ui-state-disabled)",placeholder:"ui-state-highlight",start:function(a,b){b.item.addClass("ui-state-highlight")},stop:function(a,b){b.item.removeClass("ui-state-highlight")}}),b.disableSelection()},maxHeight:400}));var oa=a("#vpl_ide_dialog_multidelete"),pa={};pa[R("selectall")]=function(){a(this).find("input").prop("checked",!0)},pa[R("deselectall")]=function(){a(this).find("input").prop("checked",!1)},pa[R("deleteselected")]=function(){var b=E.getFiles(),d=[],e=a("#vpl_multidelete_list label");e.each(function(){var c=a(this);if(c.find("input").prop("checked")){var e=c.data("fileid");d.push(b[e].getFileName())}});for(var f=0;f<d.length;f++)E.deleteFile(d[f],!1,H);c.delay("updateMenu",I),c.delay("updateFileList",E.updateFileList),a(this).dialog("close")},pa[R("cancel")]=function(){a(this).dialog("close")},oa.dialog(a.extend({},ea,{title:R("multidelete"),buttons:pa,open:function(){var b=a("#vpl_multidelete_list");b.html("");for(var d=E.getFiles(),e=K;e<d.length;e++){var f=c.sanitizeText(d[e].getFileName()),g=a('<label><input type="checkbox"> '+f+"</label>");g.data("fileid",e),b.append(g),b.append("<br>")}b.find("label").button()},maxHeight:400,maxWidth:400}));var qa=a("#vpl_ide_dialog_fontsize"),ra=a("#vpl_ide_dialog_fontsize .vpl_fontsize_slider"),sa={};sa[R("ok")]=function(){var b=ra.slider("value");E.setFontSize(b),a(this).dialog("close"),a.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify({fontSize:b}),contentType:"application/json; charset=utf-8",dataType:"json"})},sa[R("cancel")]=function(){E.setFontSize(ra.data("vpl_fontsize")),a(this).dialog("close")},sa[R("reset")]=function(){ra.slider("value",12)},qa.dialog(a.extend({},ea,{title:R("fontsize"),buttons:sa,open:function(){ra.data("vpl_fontsize",E.getFontSize()),ra.slider("value",E.getFontSize())}})),ra.slider({min:1,max:48,change:function(){var a=ra.slider("value");E.setFontSize(a),qa.find(".vpl_fontsize_slider_value").text(a)}});var ta=a("#vpl_ide_dialog_acetheme"),ua=a("#vpl_ide_dialog_acetheme select"),va={};va[R("ok")]=function(){E.setTheme(ua.val()),a(this).dialog("close"),a.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify({aceTheme:ua.val()}),contentType:"application/json; charset=utf-8",dataType:"json"})},va[R("cancel")]=function(){E.setTheme(ua.data("acetheme")),a(this).dialog("close")},va[R("reset")]=function(){ua.val(ua.data("acetheme")),E.setTheme(ua.val())},ta.dialog(a.extend({},ea,{title:R("theme"),buttons:va,modal:!1,open:function(){ua.data("acetheme",E.getTheme()),ua.val(E.getTheme())}})),ua.on("change",function(){E.setTheme(ua.val())});var wa=new f("vpl_dialog_terminal","vpl_terminal",R),xa=new g("vpl_dialog_vnc",R),ya=wa,za=a("#vpl_ide_input_file"),Aa=function(){c.readSelectedFiles(this.files,function(a){return E.addFile(a,!0,I,H)},function(){E.fileListVisibleIfNeeded()})};za.on("change",Aa),V.add({name:"filelist",originalAction:function(){E.fileListVisible(!E.isFileListVisible()),c.delay("updateMenu",I),c.delay("autoResizeTab",G),c.delay("updateFileList",E.updateFileList)},bindKey:{win:"Ctrl-L",mac:"Ctrl-L"}}),V.add({name:"new",originalAction:function(){E.length()<L&&fa.dialog("open")},bindKey:{win:"Alt-N",mac:"Option-N"}}),V.add({name:"rename",originalAction:function(){var a=E.currentFile();a&&E.getFilePosById(a.getId())>=K&&ha.dialog("open")},bindKey:{win:"Ctrl-R",mac:"Ctrl-R"}}),V.add({name:"delete",originalAction:function(){var a=E.currentFile();if(a){var b=a.getFileName(),c=R("delete_file_fq").replace(/\{\$a\}/g,b);v(c,{ok:function(){E.deleteFile(b,H)},title:R("delete_file_q"),icon:"trash"})}},bindKey:{win:"Ctrl-D",mac:"Ctrl-D"}}),V.add({name:"close",originalAction:function(){var a=E.currentFile();a&&E.close(a)},bindKey:{win:"Alt-W",mac:"Option-W"}}),V.add({name:"import",originalAction:function(){za.val(""),za.trigger("click")},bindKey:{win:"Ctrl-I",mac:"Ctrl-I"}}),V.add({name:"sort",originalAction:function(){ma.dialog("open")},bindKey:{win:"Ctrl-O",mac:"Ctrl-O"}}),V.add({name:"multidelete",originalAction:function(){oa.dialog("open")}}),V.add({name:"fontsize",originalAction:function(){qa.dialog("open")}}),V.add({name:"acetheme",originalAction:function(){ta.dialog("open")}}),V.add({name:"print",originalAction:function(){window.print()},bindKey:{win:"Alt-P",mac:"Command-P"}}),V.add({name:"undo",originalAction:function(){E.currentFile("undo")}}),V.add({name:"redo",originalAction:function(){E.currentFile("redo")}}),V.add({name:"select_all",editorName:"selectall",originalAction:function(){E.currentFile("selectAll")}}),V.add({name:"find",originalAction:function(){E.currentFile("find")}}),V.add({name:"find_replace",editorName:"replace",originalAction:function(){E.currentFile("replace")}}),V.add({name:"next",editorName:"findnext",originalAction:function(){E.currentFile("next")}}),V.add({name:"fullscreen",originalAction:function(){var b="header, footer, aside, #page-header, div.navbar, #nav-drawer";b+=", div.tabtree, #dock, .breadcrumb-nav, .moodle-actionmenu",O?(S.removeClass("vpl_ide_root_fullscreen"),a("body").removeClass("vpl_body_fullscreen"),V.setText("fullscreen","fullscreen"),a(b).show(),a("#vpl_ide_user").hide(),O=!1):(a("body").addClass("vpl_body_fullscreen").scrollTop(0),a(b).hide(),S.addClass("vpl_ide_root_fullscreen"),V.setText("fullscreen","regularscreen"),j.username&&a("#vpl_ide_user").show(),O=!0),u(),setTimeout(G,10)},bindKey:{win:"Alt-F",mac:"Ctrl-F"}}),V.add({name:"download",originalAction:function(){window.location=j.download}}),i.correctedFiles=function(){z()},V.add({name:"correctedfiles",originalAction:function(){v(R("surecorrectedfiles"),{title:R("correctedfiles"),ok:z})}}),V.add({name:"resetfiles",originalAction:function(){v(R("sureresetfiles"),{title:R("resetfiles"),ok:y})}}),V.add({name:"save",originalAction:function(){var b={files:E.getFilesToSave(),comments:a("#vpl_ide_input_comments").val()};c.requestAction("save","saving",b,j.ajaxurl).done(function(a){E.resetModified(),V.setTimeLeft(a),c.delay("updateMenu",I)}).fail(H)},bindKey:{win:"Ctrl-S",mac:"Command-S"}});var Ba={getConsole:function(){return ya},setResult:J.setResult,ajaxurl:j.ajaxurl,run:function(a,b,c){"terminal"==a?(ya=wa,wa.connect(b.executionURL,function(){c.close(),u()})):(ya=xa,xa.connect(b.secure,b.server,b.portToUse,b.VNCpassword,b.executionPath,function(){c.close(),u()}))},lastAction:!1,getLastAction:function(){var a=this.lastAction;return this.lastAction=!1,a},setLastAction:function(a){this.lastAction=a}};V.add({name:"run",originalAction:function(){Ba.setLastAction(B),B()},bindKey:{win:"Ctrl-F11",mac:"Command-U"}}),V.add({name:"debug",originalAction:function(){Ba.setLastAction(C),C()},bindKey:{win:"Alt-F11",mac:"Option-U"}}),V.add({name:"evaluate",originalAction:function(){Ba.setLastAction(D),D()},bindKey:{win:"Shift-F11",mac:"Command-Option-U"}}),V.add({name:"comments",originalAction:function(){ia.dialog("open")}}),V.add({name:"console",originalAction:function(){ya.show()}}),V.add({name:"user"}),V.add({name:"about",originalAction:function(){ja.dialog("open")}}),V.add({name:"timeleft",originalAction:function(){V.toggleTimeLeft()}}),V.add({name:"more",originalAction:function(){var b=a("#vpl_ide_menuextra");b.is(":visible")?(V.setText("more","more",c.str("more")),b.hide()):(V.setText("more","less",c.str("less")),b.show()),c.delay("updateMenu",I),c.delay("autoResizeTab",G)}}),U.addClass("ui-widget-header ui-corner-all");var Ca="";Ca+=V.getHTML("more"),Ca+=V.getHTML("save"),Ca+="<span id='vpl_ide_mexecution'>",Ca+=V.getHTML("run"),Ca+=V.getHTML("debug"),Ca+=V.getHTML("evaluate"),Ca+=V.getHTML("comments"),Ca+=V.getHTML("console"),Ca+="</span> ",Ca+="<span id='vpl_ide_menuextra'>",Ca+="<span id='vpl_ide_file'>",Ca+=V.getHTML("filelist"),Ca+=V.getHTML("new"),Ca+=V.getHTML("rename"),Ca+=V.getHTML("delete"),Ca+=V.getHTML("import"),Ca+=V.getHTML("download"),Ca+=V.getHTML("resetfiles"),Ca+=V.getHTML("correctedfiles"),Ca+=V.getHTML("sort"),Ca+=V.getHTML("multidelete"),Ca+=V.getHTML("fontsize"),Ca+=V.getHTML("acetheme"),Ca+="</span> ",Ca+="<span id='vpl_ide_edit'>",Ca+=V.getHTML("undo"),Ca+=V.getHTML("redo"),Ca+=V.getHTML("select_all"),Ca+=V.getHTML("find"),Ca+=V.getHTML("find_replace"),Ca+=V.getHTML("next"),Ca+="</span> ",Ca+="</span> ",Ca+=V.getHTML("fullscreen")+" ",Ca+=V.getHTML("about")+" ",Ca+=V.getHTML("user")+" ",Ca+=V.getHTML("timeleft"),Ca+='<div class="clearfix"></div>',U.append(Ca),a("#vpl_ide_more").button(),a("#vpl_ide_save").button(),a("#vpl_ide_menuextra").hide(),a("#vpl_ide_file").controlgroup(),a("#vpl_ide_edit").controlgroup(),a("#vpl_ide_mexecution").controlgroup(),a("#vpl_ide_fullscreen").button(),a("#vpl_ide_acetheme").button(),a("#vpl_ide_about").button(),a("#vpl_ide_user").button().css("float","right").hide(),a("#vpl_ide_timeleft").button().css("float","right").hide(),a("#vpl_menu .ui-button").css("padding","6px"),a("#vpl_menu .ui-button-text").css("padding","0");for(var Da=["filelist","more","fullscreen","about","resetfiles","download","comments","console","import","fontsize"],Ea=0;Ea<Da.length;Ea++)V.enable(Da[Ea],!0);V.setExtracontent("user",j.username),V.setTimeLeft(j),I=function(){var a,b=E.currentFile(),d=E.length();d?_.show():_.hide(),E.isFileListVisible()?V.setText("filelist","filelistclose",c.str("filelist")):V.setText("filelist","filelist",c.str("filelist")),c.log("updateMenu",!0);var e=E.isModified();V.enable("save",e),V.enable("run",!e),V.enable("debug",!e),V.enable("evaluate",!e),V.enable("download",!e),V.enable("new",d<L),V.enable("sort",d-K>1),V.enable("multidelete",d-K>1),V.enable("acetheme",!0),V.enable("correctedfiles",j.correctedfiles);var f;if(b&&0!==d){var g=E.getFilePosById(b.getId());V.enable("rename",g>=K&&0!==d),V.enable("delete",g>=K&&0!==d),V.enable("undo",b.hasUndo()),V.enable("redo",b.hasRedo()),V.enable("select_all",b.hasSelectAll()),V.enable("find",b.hasFind()),V.enable("find_replace",b.hasFindReplace()),V.enable("next",b.hasNext()),c.delay("updateFileList",E.updateFileList)}else for(f=["rename","delete","undo","redo","select_all","find","find_replace","next"],a=0;a<f.length;a++)V.enable(f[a],!1)},_.on("tabsactivate",function(){E.currentFile("focus"),c.delay("updateMenu",I),c.delay("autoResizeTab",G)});var Fa=a(window);Fa.on("resize",G),j.example||Fa.on("beforeunload",function(){if(E.isModified())return R("changesNotSaved")}),E=new p,G(),function(){function a(){var a=U.width();b!=a&&(b=a,G())}var b=U.width();a(),setInterval(a,1e3)}(),E.resetModified(),c.requestAction("load","loading",j,j.loadajaxurl).done(function(b){for(var d=!0,e=b.files,f=0;f<e.length;f++){var g=e[f],h=E.addFile(g,!1,I,H);h?(h.resetModified(),f<K||e.length<=5?E.open(h):E.fileListVisible(!0)):d=!1}c.delay("updateMenu",I),E.generateFileList(),_.tabs("option","active",0),b.compilationexecution&&J.setResult(b.compilationexecution,!1),V.setTimeLeft(b),b.comments>""&&a("#vpl_ide_input_comments").val(b.comments),d?E.resetModified():E.setModified(),0===E.length()&&L>0?V.getAction("new")():j.saved||E.setModified()}).fail(H)};return window.VPLIDE=i,{init:function(a,b){h=new i(a,b)}}});